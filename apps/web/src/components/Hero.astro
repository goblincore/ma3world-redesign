---
interface Props {
  title?: string;
  subtitle?: string;
}

import LogoGlobe from './LogoGlobe.astro';
import ButterflyLoader from './ButterflyLoader.astro';

const { title = "Digital-first Design Agency", subtitle = "We craft immersive digital experiences" } = Astro.props;
const base = import.meta.env.BASE_URL;
const assetBase = import.meta.env.PROD ? 'https://ma3worldbunny.b-cdn.net/' : base;
---

<section id="hero" class="relative h-[100svh] w-full flex items-center justify-center overflow-hidden">

  
  <!-- Background Video/Image -->
  <div class="absolute inset-0 bg-theme">
    <!-- Fallback Image (shows while video loads) -->
    <img 
      id="hero-fallback"
      src={`${assetBase}video/darkherostatic.jpg`}
      alt=""
      class="absolute inset-0 w-full h-full object-cover transition-opacity duration-700"
    />
    
    <video
      id="hero-video"
      autoplay
      muted
      loop
      playsinline
      class="relative z-10 w-full h-full object-cover opacity-0 transition-opacity duration-1000"
    >
    <source id="hero-video-source" src={`${assetBase}video/loopingyua.mp4`} type="video/mp4" />
    </video>
    <!-- Overlays -->
    <div class="absolute inset-0 bg-black/20 z-10"></div>
    <div class="absolute inset-x-0 top-0 h-64 hero-top-gradient z-20 pointer-events-none"></div>
    
    <!-- Initial Loading Overlay -->
    <div id="video-loader" class="absolute inset-0 bg-theme z-30 transition-opacity duration-700">
      <ButterflyLoader />
    </div>
  </div>
  
  <!-- Content -->
  <div class="absolute bottom-28 left-6 md:bottom-24 md:left-12 z-40 w-full max-w-[85vw] md:max-w-[40vw] flex flex-col items-start">
    <!-- News Link with Cute Owl -->
    <a href={`${base}news`} class="group flex items-center gap-2 mb-3 hover:opacity-100 transition-all">
      <div class="news-icon-container relative w-7 h-7 md:w-9 md:h-9">
        <svg viewBox="0 0 100 100" class="w-full h-full drop-shadow-sm transition-transform group-hover:scale-110">
          <g fill="none" stroke="white" stroke-width="2.5">
            <!-- Owl Body -->
            <circle cx="50" cy="55" r="35" />
            <!-- Ear Tufts (Sharp/Detailed) -->
            <path d="M25 35 L12 15 L38 28" stroke-linecap="round" />
            <path d="M75 35 L88 15 L62 28" stroke-linecap="round" />
            
            <!-- Wings (Feathered / Prominent) -->
            <g class="wing-left transition-transform duration-500 origin-[20px_50px]">
              <path d="M15 50 C5 60, 5 80, 20 85 M15 65 C10 70, 10 75, 15 78" />
            </g>
            <g class="wing-right transition-transform duration-500 origin-[80px_50px]">
              <path d="M85 50 C95 60, 95 80, 80 85 M85 65 C90 70, 90 75, 85 78" />
            </g>
            
            <!-- Beak (Detailed triangle) -->
            <path d="M50 64 L44 56 L56 56 Z" fill="white" stroke="none" />
            
            <!-- Clawed Feet (Prominent 3-taloned) -->
            <g stroke-linecap="round" stroke-width="3">
              <!-- Left Talon -->
              <path d="M35 88 L30 96" />
              <path d="M40 88 L40 98" />
              <path d="M45 88 L50 96" />
              <!-- Right Talon -->
              <path d="M55 88 L50 96" />
              <path d="M60 88 L60 98" />
              <path d="M65 88 L70 96" />
            </g>
            
            <!-- Glasses (Larger proportion) -->
            <g stroke-width="2">
              <circle cx="37" cy="52" r="14" />
              <circle cx="63" cy="52" r="14" />
              <path d="M49 52 L51 52" />
            </g>
            
            <!-- Eyes (Bigger Pupils on hover) -->
            <g class="eyes opacity-0 group-hover:opacity-100 transition-opacity duration-300">
              <circle cx="37" cy="52" r="4.5" fill="white" stroke="none" class="eye-pupil" />
              <circle cx="63" cy="52" r="4.5" fill="white" stroke="none" class="eye-pupil" />
            </g>
            <!-- Closed Eyes (Smiling) -->
            <g class="closed-eyes group-hover:opacity-0 transition-opacity duration-300">
              <path d="M30 52 Q37 57 44 52" />
              <path d="M56 52 Q63 57 70 52" />
            </g>
          </g>
        </svg>
      </div>
      <span class="text-[10px] md:text-xs uppercase tracking-[0.2em] font-bold text-white/80 group-hover:text-white border-b border-white/20 pb-1 translate-y-[2px]">
        <span class="lang-en">Read latest news</span>
        <span class="lang-ja">最新ニュースを読む</span>
      </span>
    </a>

    <!-- Logo & Wireframe Globe -->
    <LogoGlobe logoColor="white" forceColor="white" className="relative w-full h-auto" />
    <h1 class="sr-only">
      <span class="lang-en">{title}</span>
      <span class="lang-ja">デジタル・ファーストのデザイン・エージェンシー</span>
    </h1>
  </div>
  
  <!-- Scroll Indicator -->
  <div class="absolute top-1/2 -translate-y-1/2 right-4 md:top-auto md:translate-y-0 md:bottom-12 md:right-12 flex flex-col items-center gap-4 z-40">
    <span class="text-[10px] tracking-[0.2em] uppercase text-white/60 vertical-text font-bold">
      <span class="lang-en">Scroll</span>
      <span class="lang-ja">スクロール</span>
    </span>
    <div class="w-px h-24 bg-gradient-to-b from-white/60 to-transparent relative overflow-hidden">
      <div class="absolute top-0 left-0 w-full h-1/2 bg-white scroll-line-anim"></div>
    </div>
  </div>
</section>

<style>
  .vertical-text {
    writing-mode: vertical-rl;
    text-orientation: mixed;
  }

  .scroll-line-anim {
    animation: scroll-line 2s cubic-bezier(0.76, 0, 0.24, 1) infinite;
  }

  .group:hover .news-icon-container svg {
    animation: nod 0.6s ease-in-out infinite alternate;
  }

  @keyframes nod {
    from { transform: rotate(-5deg); }
    to { transform: rotate(5deg); }
  }

  .eye-pupil {
    transform-origin: center;
  }

  .group:hover .eye-pupil {
    animation: blink 3s infinite;
  }

  @keyframes blink {
    0%, 90%, 100% { transform: scaleY(1); }
    95% { transform: scaleY(0.1); }
  }

  .group:hover .wing-left {
    transform: rotate(25deg);
  }

  .group:hover .wing-right {
    transform: rotate(-25deg);
  }

  @keyframes scroll-line {
    0% {
      transform: translateY(-100%);
    }
    50% {
      transform: translateY(200%);
    }
    100% {
      transform: translateY(200%);
    }
  }

  /* Theme-aware Top Gradient */
  .hero-top-gradient {
    transition: background 1s ease;
  }

  /* Dark theme: subtle dark gradient */
  :root:not([data-theme="light"]) .hero-top-gradient {
    background: linear-gradient(to bottom, 
      rgba(0, 0, 0, 0.45) 0%, 
      rgba(0, 0, 0, 0.15) 50%, 
      transparent 100%
    );
  }

  /* Light theme: smooth eased vertical wash */
  :root[data-theme="light"] .hero-top-gradient {
    background: linear-gradient(
      to bottom,
      rgba(255, 255, 255, 0.6) 0%,
      rgba(255, 255, 255, 0.4) 20%,
      rgba(255, 255, 255, 0.2) 45%,
      rgba(255, 255, 255, 0.05) 70%,
      rgba(255, 255, 255, 0) 100%
    );
  }

  @media (max-width: 768px) {
    :root[data-theme="light"] .hero-top-gradient {
      /* Just a slightly deeper vertical fade for mobile, no corner shapes */
      background: linear-gradient(
        to bottom,
        rgba(255, 255, 255, 0.75) 0%,
        rgba(255, 255, 255, 0.4) 35%,
        rgba(255, 255, 255, 0.1) 70%,
        rgba(255, 255, 255, 0) 100%
      );
    }
  }
</style>

<script define:vars={{ base, assetBase: import.meta.env.PROD ? 'https://ma3worldbunny.b-cdn.net/' : base }}>
  const video = document.getElementById('hero-video');
  const fallback = document.getElementById('hero-fallback');
  const source = document.getElementById('hero-video-source');
  const loader = document.getElementById('video-loader');
  
  const handleVideoPlay = () => {
    if (video && loader) {
      video.classList.remove('opacity-0');
      video.classList.add('opacity-100');
      loader.classList.add('opacity-0');
      setTimeout(() => loader.style.display = 'none', 700);
    }
  };

  if (video) {
    video.addEventListener('playing', handleVideoPlay, { once: true });
    // Fallback if event doesn't fire
    if (video.readyState >= 3) handleVideoPlay();
  }

  const handleFallbackLoad = () => {
    if (loader) {
      loader.classList.add('opacity-0');
      setTimeout(() => loader.style.display = 'none', 700);
    }
  };

  if (fallback) {
    if (fallback.complete) {
      handleFallbackLoad();
    } else {
      fallback.addEventListener('load', handleFallbackLoad, { once: true });
    }
  }

  const attemptPlay = () => {
    video.play().catch(error => {
      console.log("Autoplay blocked, waiting for interaction...");
      const enableVideo = () => {
        video.play();
        document.removeEventListener('touchstart', enableVideo);
        document.removeEventListener('click', enableVideo);
      };
      document.addEventListener('touchstart', enableVideo, { once: true });
      document.addEventListener('click', enableVideo, { once: true });
    });
  };

  const updateVideoSource = () => {
    const isLight = document.documentElement.getAttribute('data-theme') === 'light';
    const newSrc = isLight ? `${assetBase}video/lightloop2.mp4` : `${assetBase}video/loopingyua.mp4`;
    const newFallbackSrc = isLight ? `${assetBase}video/lightherostatic.jpg` : `${assetBase}video/darkherostatic.jpg`;
    
    // Update fallback image immediately
    if (fallback && fallback.getAttribute('src') !== newFallbackSrc) {
      fallback.setAttribute('src', newFallbackSrc);
    }

    if (source && source.getAttribute('src') !== newSrc) {
      if (loader) {
        loader.style.display = 'block';
        loader.classList.remove('opacity-0');
      }
      video.classList.add('opacity-0');
      source.setAttribute('src', newSrc);
      video.load();
      attemptPlay();
      video.addEventListener('playing', handleVideoPlay, { once: true });
    }
  };

  // Initial check
  updateVideoSource();

  // Watch for theme changes
  const observer = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
      if (mutation.type === 'attributes' && mutation.attributeName === 'data-theme') {
        updateVideoSource();
      }
    });
  });

  observer.observe(document.documentElement, {
    attributes: true,
    attributeFilter: ['data-theme']
  });
</script>
