---
interface Props {
  class?: string;
}

const { class: className = "" } = Astro.props;
---

<div id="fullpage-wrapper" class={`fullpage-wrapper ${className}`}>
  <slot />
</div>

<style>
  .fullpage-wrapper {
    /* Mobile: normal scrolling */
    height: auto;
    overflow-y: visible;
  }
  
  .fullpage-wrapper::-webkit-scrollbar {
    display: none;
  }
  
  .fullpage-wrapper {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
  
  /* Mobile: sections can be any height */
  .fullpage-wrapper > :global(section),
  .fullpage-wrapper > :global(footer) {
    min-height: 100vh;
    height: auto;
  }
  
  /* Desktop: fullpage scroll-snap */
  @media (min-width: 1024px) {
    .fullpage-wrapper {
      height: 100vh;
      overflow-y: scroll;
      scroll-snap-type: y mandatory;
      scroll-behavior: smooth;
    }
    
    .fullpage-wrapper > :global(section),
    .fullpage-wrapper > :global(footer) {
      scroll-snap-align: start;
      scroll-snap-stop: always;
      height: 100vh;
      min-height: 100vh;
      overflow: hidden;
    }
  }
</style>

<script>
  const wrapper = document.getElementById('fullpage-wrapper');
  if (!wrapper) throw new Error('Fullpage wrapper not found');
  
  const sections = ['hero', 'about', 'projects', 'contact'];
  let currentSlide = 0;
  
  const goToSlide = (index: number) => {
    if (index < 0 || index >= sections.length) return;
    currentSlide = index;
    
    const el = document.getElementById(sections[index]);
    if (el) {
      el.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    window.dispatchEvent(new CustomEvent('section-changed', { detail: { index } }));
  };
  
  // @ts-ignore - expose globally
  window.goToSlide = goToSlide;
  
  // Track scroll position
  let scrollTimeout: ReturnType<typeof setTimeout>;
  
  wrapper.addEventListener('scroll', () => {
    clearTimeout(scrollTimeout);
    scrollTimeout = setTimeout(() => {
      const scrollTop = wrapper.scrollTop;
      
      let closestIndex = 0;
      let minDiff = Infinity;
      
      sections.forEach((id, i) => {
        const el = document.getElementById(id);
        if (!el) return;
        const diff = Math.abs(el.offsetTop - scrollTop);
        if (diff < minDiff) {
          minDiff = diff;
          closestIndex = i;
        }
      });
      
      if (closestIndex !== currentSlide) {
        currentSlide = closestIndex;
        window.dispatchEvent(new CustomEvent('section-changed', { detail: { index: currentSlide } }));
      }
    }, 100);
  });
  
  // Keyboard navigation
  window.addEventListener('keydown', (e) => {
    switch(e.key) {
      case 'ArrowDown':
      case 'PageDown':
      case ' ':
        e.preventDefault();
        goToSlide(currentSlide + 1);
        break;
      case 'ArrowUp':
      case 'PageUp':
        e.preventDefault();
        goToSlide(currentSlide - 1);
        break;
      case 'Home':
        e.preventDefault();
        goToSlide(0);
        break;
      case 'End':
        e.preventDefault();
        goToSlide(sections.length - 1);
        break;
    }
  });
  
  // Initial state
  setTimeout(() => {
    window.dispatchEvent(new CustomEvent('section-changed', { detail: { index: 0 } }));
  }, 100);
</script>
